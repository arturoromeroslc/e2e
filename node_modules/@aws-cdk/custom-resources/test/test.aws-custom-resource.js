"use strict";
const assert_1 = require("@aws-cdk/assert");
const iam = require("@aws-cdk/aws-iam");
const cdk = require("@aws-cdk/core");
const lib_1 = require("../lib");
module.exports = {
    'aws sdk js custom resource with onCreate and onDelete'(test) {
        // GIVEN
        const stack = new cdk.Stack();
        // WHEN
        new lib_1.AwsCustomResource(stack, 'AwsSdk', {
            onCreate: {
                service: 'CloudWatchLogs',
                action: 'putRetentionPolicy',
                parameters: {
                    logGroupName: '/aws/lambda/loggroup',
                    retentionInDays: 90
                },
                physicalResourceId: 'loggroup'
            },
            onDelete: {
                service: 'CloudWatchLogs',
                action: 'deleteRetentionPolicy',
                parameters: {
                    logGroupName: '/aws/lambda/loggroup',
                }
            }
        });
        // THEN
        assert_1.expect(stack).to(assert_1.haveResource('Custom::AWS', {
            "Create": {
                "service": "CloudWatchLogs",
                "action": "putRetentionPolicy",
                "parameters": {
                    "logGroupName": "/aws/lambda/loggroup",
                    "retentionInDays": 90
                },
                "physicalResourceId": "loggroup"
            },
            "Delete": {
                "service": "CloudWatchLogs",
                "action": "deleteRetentionPolicy",
                "parameters": {
                    "logGroupName": "/aws/lambda/loggroup"
                }
            }
        }));
        assert_1.expect(stack).to(assert_1.haveResource('AWS::IAM::Policy', {
            "PolicyDocument": {
                "Statement": [
                    {
                        "Action": "logs:PutRetentionPolicy",
                        "Effect": "Allow",
                        "Resource": "*"
                    },
                    {
                        "Action": "logs:DeleteRetentionPolicy",
                        "Effect": "Allow",
                        "Resource": "*"
                    }
                ],
                "Version": "2012-10-17"
            },
        }));
        test.done();
    },
    'onCreate defaults to onUpdate'(test) {
        // GIVEN
        const stack = new cdk.Stack();
        // WHEN
        new lib_1.AwsCustomResource(stack, 'AwsSdk', {
            onUpdate: {
                service: 's3',
                action: 'putObject',
                parameters: {
                    Bucket: 'my-bucket',
                    Key: 'my-key',
                    Body: 'my-body'
                },
                physicalResourceIdPath: 'ETag'
            },
        });
        // THEN
        assert_1.expect(stack).to(assert_1.haveResource('Custom::AWS', {
            "Create": {
                "service": "s3",
                "action": "putObject",
                "parameters": {
                    "Bucket": "my-bucket",
                    "Key": "my-key",
                    "Body": "my-body"
                },
                "physicalResourceIdPath": "ETag"
            },
            "Update": {
                "service": "s3",
                "action": "putObject",
                "parameters": {
                    "Bucket": "my-bucket",
                    "Key": "my-key",
                    "Body": "my-body"
                },
                "physicalResourceIdPath": "ETag"
            },
        }));
        test.done();
    },
    'with custom policyStatements'(test) {
        // GIVEN
        const stack = new cdk.Stack();
        // WHEN
        new lib_1.AwsCustomResource(stack, 'AwsSdk', {
            onUpdate: {
                service: 'S3',
                action: 'putObject',
                parameters: {
                    Bucket: 'my-bucket',
                    Key: 'my-key',
                    Body: 'my-body'
                },
                physicalResourceIdPath: 'ETag'
            },
            policyStatements: [
                new iam.PolicyStatement({
                    actions: ['s3:PutObject'],
                    resources: ['arn:aws:s3:::my-bucket/my-key']
                })
            ]
        });
        // THEN
        assert_1.expect(stack).to(assert_1.haveResource('AWS::IAM::Policy', {
            "PolicyDocument": {
                "Statement": [
                    {
                        "Action": "s3:PutObject",
                        "Effect": "Allow",
                        "Resource": "arn:aws:s3:::my-bucket/my-key"
                    },
                ],
                "Version": "2012-10-17"
            },
        }));
        test.done();
    },
    'fails when no calls are specified'(test) {
        const stack = new cdk.Stack();
        test.throws(() => {
            new lib_1.AwsCustomResource(stack, 'AwsSdk', {});
        }, /`onCreate`.+`onUpdate`.+`onDelete`/);
        test.done();
    },
    'fails when no physical resource method is specified'(test) {
        const stack = new cdk.Stack();
        test.throws(() => {
            new lib_1.AwsCustomResource(stack, 'AwsSdk', {
                onUpdate: {
                    service: 'CloudWatchLogs',
                    action: 'putRetentionPolicy',
                    parameters: {
                        logGroupName: '/aws/lambda/loggroup',
                        retentionInDays: 90
                    }
                }
            });
        }, /`physicalResourceId`.+`physicalResourceIdPath`/);
        test.done();
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC5hd3MtY3VzdG9tLXJlc291cmNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidGVzdC5hd3MtY3VzdG9tLXJlc291cmNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSw0Q0FBdUQ7QUFDdkQsd0NBQXlDO0FBQ3pDLHFDQUFzQztBQUV0QyxnQ0FBMkM7QUFJM0MsaUJBQVM7SUFDUCx1REFBdUQsQ0FBQyxJQUFVO1FBQ2hFLFFBQVE7UUFDUixNQUFNLEtBQUssR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUU5QixPQUFPO1FBQ1AsSUFBSSx1QkFBaUIsQ0FBQyxLQUFLLEVBQUUsUUFBUSxFQUFFO1lBQ3JDLFFBQVEsRUFBRTtnQkFDUixPQUFPLEVBQUUsZ0JBQWdCO2dCQUN6QixNQUFNLEVBQUUsb0JBQW9CO2dCQUM1QixVQUFVLEVBQUU7b0JBQ1YsWUFBWSxFQUFFLHNCQUFzQjtvQkFDcEMsZUFBZSxFQUFFLEVBQUU7aUJBQ3BCO2dCQUNELGtCQUFrQixFQUFFLFVBQVU7YUFDL0I7WUFDRCxRQUFRLEVBQUU7Z0JBQ1IsT0FBTyxFQUFFLGdCQUFnQjtnQkFDekIsTUFBTSxFQUFFLHVCQUF1QjtnQkFDL0IsVUFBVSxFQUFFO29CQUNWLFlBQVksRUFBRSxzQkFBc0I7aUJBQ3JDO2FBQ0Y7U0FDRixDQUFDLENBQUM7UUFFSCxPQUFPO1FBQ1AsZUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxxQkFBWSxDQUFDLGFBQWEsRUFBRTtZQUMzQyxRQUFRLEVBQUU7Z0JBQ1IsU0FBUyxFQUFFLGdCQUFnQjtnQkFDM0IsUUFBUSxFQUFFLG9CQUFvQjtnQkFDOUIsWUFBWSxFQUFFO29CQUNaLGNBQWMsRUFBRSxzQkFBc0I7b0JBQ3RDLGlCQUFpQixFQUFFLEVBQUU7aUJBQ3RCO2dCQUNELG9CQUFvQixFQUFFLFVBQVU7YUFDakM7WUFDRCxRQUFRLEVBQUU7Z0JBQ1IsU0FBUyxFQUFFLGdCQUFnQjtnQkFDM0Is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QixXQUFXLEVBQUU7b0JBQ1g7d0JBQ0UsUUFBUSxFQUFFLGNBQWM7d0JBQ3hCLFFBQVEsRUFBRSxPQUFPO3dCQUNqQixVQUFVLEVBQUUsK0JBQStCO3FCQUM1QztpQkFDRjtnQkFDRCxTQUFTLEVBQUUsWUFBWTthQUN4QjtTQUNGLENBQUMsQ0FBQyxDQUFDO1FBRUosSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ2QsQ0FBQztJQUVELG1DQUFtQyxDQUFDLElBQVU7UUFDNUMsTUFBTSxLQUFLLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7UUFFOUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUU7WUFDZixJQUFJLHVCQUFpQixDQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDN0MsQ0FBQyxFQUFFLG9DQUFvQyxDQUFDLENBQUM7UUFFekMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ2QsQ0FBQztJQUVELHFEQUFxRCxDQUFDLElBQVU7UUFDOUQsTUFBTSxLQUFLLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7UUFFOUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUU7WUFDZixJQUFJLHVCQUFpQixDQUFDLEtBQUssRUFBRSxRQUFRLEVBQUU7Z0JBQ3JDLFFBQVEsRUFBRTtvQkFDUixPQUFPLEVBQUUsZ0JBQWdCO29CQUN6QixNQUFNLEVBQUUsb0JBQW9CO29CQUM1QixVQUFVLEVBQUU7d0JBQ1YsWUFBWSxFQUFFLHNCQUFzQjt3QkFDcEMsZUFBZSxFQUFFLEVBQUU7cUJBQ3BCO2lCQUNGO2FBQ0YsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxFQUFFLGdEQUFnRCxDQUFDLENBQUM7UUFFckQsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ2QsQ0FBQztDQUNGLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBleHBlY3QsIGhhdmVSZXNvdXJjZSB9IGZyb20gJ0Bhd3MtY2RrL2Fzc2VydCc7XG5pbXBvcnQgaWFtID0gcmVxdWlyZSgnQGF3cy1jZGsvYXdzLWlhbScpO1xuaW1wb3J0IGNkayA9IHJlcXVpcmUoJ0Bhd3MtY2RrL2NvcmUnKTtcbmltcG9ydCB7IFRlc3QgfSBmcm9tICdub2RldW5pdCc7XG5pbXBvcnQgeyBBd3NDdXN0b21SZXNvdXJjZSB9IGZyb20gJy4uL2xpYic7XG5cbi8vIHRzbGludDpkaXNhYmxlOm9iamVjdC1saXRlcmFsLWtleS1xdW90ZXNcblxuZXhwb3J0ID0ge1xuICAnYXdzIHNkayBqcyBjdXN0b20gcmVzb3VyY2Ugd2l0aCBvbkNyZWF0ZSBhbmQgb25EZWxldGUnKHRlc3Q6IFRlc3QpIHtcbiAgICAvLyBHSVZFTlxuICAgIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuXG4gICAgLy8gV0hFTlxuICAgIG5ldyBBd3NDdXN0b21SZXNvdXJjZShzdGFjaywgJ0F3c1NkaycsIHtcbiAgICAgIG9uQ3JlYXRlOiB7XG4gICAgICAgIHNlcnZpY2U6ICdDbG91ZFdhdGNoTG9ncycsXG4gICAgICAgIGFjdGlvbjogJ3B1dFJldGVudGlvblBvbGljeScsXG4gICAgICAgIHBhcmFtZXRlcnM6IHtcbiAgICAgICAgICBsb2dHcm91cE5hbWU6ICcvYXdzL2xhbWJkYS9sb2dncm91cCcsXG4gICAgICAgICAgcmV0ZW50aW9uSW5EYXlzOiA5MFxuICAgICAgICB9LFxuICAgICAgICBwaHlzaWNhbFJlc291cmNlSWQ6ICdsb2dncm91cCdcbiAgICAgIH0sXG4gICAgICBvbkRlbGV0ZToge1xuICAgICAgICBzZXJ2aWNlOiAnQ2xvdWRXYXRjaExvZ3MnLFxuICAgICAgICBhY3Rpb246ICdkZWxldGVSZXRlbnRpb25Qb2xpY3knLFxuICAgICAgICBwYXJhbWV0ZXJzOiB7XG4gICAgICAgICAgbG9nR3JvdXBOYW1lOiAnL2F3cy9sYW1iZGEvbG9nZ3JvdXAnLFxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICAvLyBUSEVOXG4gICAgZXhwZWN0KHN0YWNrKS50byhoYXZlUmVzb3VyY2UoJ0N1c3RvbTo6QVdTJywge1xuICAgICAgXCJDcmVhdGVcIjoge1xuICAgICAgICBcInNlcnZpY2VcIjogXCJDbG91ZFdhdGNoTG9nc1wiLFxuICAgICAgICBcImFjdGlvblwiOiBcInB1dFJldGVudGlvblBvbGljeVwiLFxuICAgICAgICBcInBhcmFtZXRlcnNcIjoge1xuICAgICAgICAgIFwibG9nR3JvdXBOYW1lXCI6IFwiL2F3cy9sYW1iZGEvbG9nZ3JvdXBcIixcbiAgICAgICAgICBcInJldGVudGlvbkluRGF5c1wiOiA5MFxuICAgICAgICB9LFxuICAgICAgICBcInBoeXNpY2FsUmVzb3VyY2VJZFwiOiBcImxvZ2dyb3VwXCJcbiAgICAgIH0sXG4gICAgICBcIkRlbGV0ZVwiOiB7XG4gICAgICAgIFwic2VydmljZVwiOiBcIkNsb3VkV2F0Y2hMb2dzXCIsXG4gICAgICAgIFwiYWN0aW9uXCI6IFwiZGVsZXRlUmV0ZW50aW9uUG9saWN5XCIsXG4gICAgICAgIFwicGFyYW1ldGVyc1wiOiB7XG4gICAgICAgICAgXCJsb2dHcm91cE5hbWVcIjogXCIvYXdzL2xhbWJkYS9sb2dncm91cFwiXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KSk7XG5cbiAgICBleHBlY3Qoc3RhY2spLnRvKGhhdmVSZXNvdXJjZSgnQVdTOjpJQU06OlBvbGljeScsIHtcbiAgICAgIFwiUG9saWN5RG9jdW1lbnRcIjoge1xuICAgICAgICBcIlN0YXRlbWVudFwiOiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgXCJBY3Rpb25cIjogXCJsb2dzOlB1dFJldGVudGlvblBvbGljeVwiLFxuICAgICAgICAgICAgXCJFZmZlY3RcIjogXCJBbGxvd1wiLFxuICAgICAgICAgICAgXCJSZXNvdXJjZVwiOiBcIipcIlxuICAgICAgICAgIH0sXG4gICAgICAgICAge1xuICAgICAgICAgICAgXCJBY3Rpb25cIjogXCJsb2dzOkRlbGV0ZVJldGVudGlvblBvbGljeVwiLFxuICAgICAgICAgICAgXCJFZmZlY3RcIjogXCJBbGxvd1wiLFxuICAgICAgICAgICAgXCJSZXNvdXJjZVwiOiBcIipcIlxuICAgICAgICAgIH1cbiAgICAgICAgXSxcbiAgICAgICAgXCJWZXJzaW9uXCI6IFwiMjAxMi0xMC0xN1wiXG4gICAgICB9LFxuICAgIH0pKTtcblxuICAgIHRlc3QuZG9uZSgpO1xuICB9LFxuXG4gICdvbkNyZWF0ZSBkZWZhdWx0cyB0byBvblVwZGF0ZScodGVzdDogVGVzdCkge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG5cbiAgICAvLyBXSEVOXG4gICAgbmV3IEF3c0N1c3RvbVJlc291cmNlKHN0YWNrLCAnQXdzU2RrJywge1xuICAgICAgb25VcGRhdGU6IHtcbiAgICAgICAgc2VydmljZTogJ3MzJyxcbiAgICAgICAgYWN0aW9uOiAncHV0T2JqZWN0JyxcbiAgICAgICAgcGFyYW1ldGVyczoge1xuICAgICAgICAgIEJ1Y2tldDogJ215LWJ1Y2tldCcsXG4gICAgICAgICAgS2V5OiAnbXkta2V5JyxcbiAgICAgICAgICBCb2R5OiAnbXktYm9keSdcbiAgICAgICAgfSxcbiAgICAgICAgcGh5c2ljYWxSZXNvdXJjZUlkUGF0aDogJ0VUYWcnXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdChzdGFjaykudG8oaGF2ZVJlc291cmNlKCdDdXN0b206OkFXUycsIHtcbiAgICAgIFwiQ3JlYXRlXCI6IHtcbiAgICAgICAgXCJzZXJ2aWNlXCI6IFwiczNcIixcbiAgICAgICAgXCJhY3Rpb25cIjogXCJwdXRPYmplY3RcIixcbiAgICAgICAgXCJwYXJhbWV0ZXJzXCI6IHtcbiAgICAgICAgICBcIkJ1Y2tldFwiOiBcIm15LWJ1Y2tldFwiLFxuICAgICAgICAgIFwiS2V5XCI6IFwibXkta2V5XCIsXG4gICAgICAgICAgXCJCb2R5XCI6IFwibXktYm9keVwiXG4gICAgICAgIH0sXG4gICAgICAgIFwicGh5c2ljYWxSZXNvdXJjZUlkUGF0aFwiOiBcIkVUYWdcIlxuICAgICAgfSxcbiAgICAgIFwiVXBkYXRlXCI6IHtcbiAgICAgICAgXCJzZXJ2aWNlXCI6IFwiczNcIixcbiAgICAgICAgXCJhY3Rpb25cIjogXCJwdXRPYmplY3RcIixcbiAgICAgICAgXCJwYXJhbWV0ZXJzXCI6IHtcbiAgICAgICAgICBcIkJ1Y2tldFwiOiBcIm15LWJ1Y2tldFwiLFxuICAgICAgICAgIFwiS2V5XCI6IFwibXkta2V5XCIsXG4gICAgICAgICAgXCJCb2R5XCI6IFwibXktYm9keVwiXG4gICAgICAgIH0sXG4gICAgICAgIFwicGh5c2ljYWxSZXNvdXJjZUlkUGF0aFwiOiBcIkVUYWdcIlxuICAgICAgfSxcbiAgICB9KSk7XG5cbiAgICB0ZXN0LmRvbmUoKTtcbiAgfSxcblxuICAnd2l0aCBjdXN0b20gcG9saWN5U3RhdGVtZW50cycodGVzdDogVGVzdCkge1xuICAgIC8vIEdJVkVOXG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG5cbiAgICAvLyBXSEVOXG4gICAgbmV3IEF3c0N1c3RvbVJlc291cmNlKHN0YWNrLCAnQXdzU2RrJywge1xuICAgICAgb25VcGRhdGU6IHtcbiAgICAgICAgc2VydmljZTogJ1MzJyxcbiAgICAgICAgYWN0aW9uOiAncHV0T2JqZWN0JyxcbiAgICAgICAgcGFyYW1ldGVyczoge1xuICAgICAgICAgIEJ1Y2tldDogJ215LWJ1Y2tldCcsXG4gICAgICAgICAgS2V5OiAnbXkta2V5JyxcbiAgICAgICAgICBCb2R5OiAnbXktYm9keSdcbiAgICAgICAgfSxcbiAgICAgICAgcGh5c2ljYWxSZXNvdXJjZUlkUGF0aDogJ0VUYWcnXG4gICAgICB9LFxuICAgICAgcG9saWN5U3RhdGVtZW50czogW1xuICAgICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgYWN0aW9uczogWydzMzpQdXRPYmplY3QnXSxcbiAgICAgICAgICByZXNvdXJjZXM6IFsnYXJuOmF3czpzMzo6Om15LWJ1Y2tldC9teS1rZXknXVxuICAgICAgICB9KVxuICAgICAgXVxuICAgIH0pO1xuXG4gICAgLy8gVEhFTlxuICAgIGV4cGVjdChzdGFjaykudG8oaGF2ZVJlc291cmNlKCdBV1M6OklBTTo6UG9saWN5Jywge1xuICAgICAgXCJQb2xpY3lEb2N1bWVudFwiOiB7XG4gICAgICAgIFwiU3RhdGVtZW50XCI6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICBcIkFjdGlvblwiOiBcInMzOlB1dE9iamVjdFwiLFxuICAgICAgICAgICAgXCJFZmZlY3RcIjogXCJBbGxvd1wiLFxuICAgICAgICAgICAgXCJSZXNvdXJjZVwiOiBcImFybjphd3M6czM6OjpteS1idWNrZXQvbXkta2V5XCJcbiAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgICBcIlZlcnNpb25cIjogXCIyMDEyLTEwLTE3XCJcbiAgICAgIH0sXG4gICAgfSkpO1xuXG4gICAgdGVzdC5kb25lKCk7XG4gIH0sXG5cbiAgJ2ZhaWxzIHdoZW4gbm8gY2FsbHMgYXJlIHNwZWNpZmllZCcodGVzdDogVGVzdCkge1xuICAgIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjaygpO1xuXG4gICAgdGVzdC50aHJvd3MoKCkgPT4ge1xuICAgICAgbmV3IEF3c0N1c3RvbVJlc291cmNlKHN0YWNrLCAnQXdzU2RrJywge30pO1xuICAgIH0sIC9gb25DcmVhdGVgLitgb25VcGRhdGVgLitgb25EZWxldGVgLyk7XG5cbiAgICB0ZXN0LmRvbmUoKTtcbiAgfSxcblxuICAnZmFpbHMgd2hlbiBubyBwaHlzaWNhbCByZXNvdXJjZSBtZXRob2QgaXMgc3BlY2lmaWVkJyh0ZXN0OiBUZXN0KSB7XG4gICAgY29uc3Qgc3RhY2sgPSBuZXcgY2RrLlN0YWNrKCk7XG5cbiAgICB0ZXN0LnRocm93cygoKSA9PiB7XG4gICAgICBuZXcgQXdzQ3VzdG9tUmVzb3VyY2Uoc3RhY2ssICdBd3NTZGsnLCB7XG4gICAgICAgIG9uVXBkYXRlOiB7XG4gICAgICAgICAgc2VydmljZTogJ0Nsb3VkV2F0Y2hMb2dzJyxcbiAgICAgICAgICBhY3Rpb246ICdwdXRSZXRlbnRpb25Qb2xpY3knLFxuICAgICAgICAgIHBhcmFtZXRlcnM6IHtcbiAgICAgICAgICAgIGxvZ0dyb3VwTmFtZTogJy9hd3MvbGFtYmRhL2xvZ2dyb3VwJyxcbiAgICAgICAgICAgIHJldGVudGlvbkluRGF5czogOTBcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0sIC9gcGh5c2ljYWxSZXNvdXJjZUlkYC4rYHBoeXNpY2FsUmVzb3VyY2VJZFBhdGhgLyk7XG5cbiAgICB0ZXN0LmRvbmUoKTtcbiAgfVxufTtcbiJdfQ==