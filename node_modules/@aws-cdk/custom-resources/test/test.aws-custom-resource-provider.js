"use strict";
const AWS = require("aws-sdk-mock");
const nock = require("nock");
const sinon = require("sinon");
const aws_custom_resource_provider_1 = require("../lib/aws-custom-resource-provider");
const eventCommon = {
    ServiceToken: 'token',
    ResponseURL: 'https://localhost',
    StackId: 'stackId',
    RequestId: 'requestId',
    LogicalResourceId: 'logicalResourceId',
    ResourceType: 'Custom::AWS',
};
function createRequest(bodyPredicate) {
    return nock('https://localhost')
        .put('/', bodyPredicate)
        .reply(200);
}
module.exports = {
    'tearDown'(callback) {
        AWS.restore();
        nock.cleanAll();
        callback();
    },
    async 'create event with physical resource id path'(test) {
        const listObjectsFake = sinon.fake.resolves({
            Contents: [
                {
                    Key: 'first-key',
                    ETag: 'first-key-etag'
                },
                {
                    Key: 'second-key',
                    ETag: 'second-key-etag',
                }
            ]
        });
        AWS.mock('S3', 'listObjects', listObjectsFake);
        const event = {
            ...eventCommon,
            RequestType: 'Create',
            ResourceProperties: {
                ServiceToken: 'token',
                Create: {
                    service: 'S3',
                    action: 'listObjects',
                    parameters: {
                        Bucket: 'my-bucket'
                    },
                    physicalResourceIdPath: 'Contents.1.ETag'
                }
            }
        };
        const request = createRequest(body => body.Status === 'SUCCESS' &&
            body.PhysicalResourceId === 'second-key-etag' &&
            body.Data['Contents.0.Key'] === 'first-key');
        await aws_custom_resource_provider_1.handler(event, {});
        sinon.assert.calledWith(listObjectsFake, {
            Bucket: 'my-bucket'
        });
        test.equal(request.isDone(), true);
        test.done();
    },
    async 'update event with physical resource id'(test) {
        const publish = sinon.fake.resolves({});
        AWS.mock('SNS', 'publish', publish);
        const event = {
            ...eventCommon,
            RequestType: 'Update',
            PhysicalResourceId: 'physicalResourceId',
            OldResourceProperties: {},
            ResourceProperties: {
                ServiceToken: 'token',
                Update: {
                    service: 'SNS',
                    action: 'publish',
                    parameters: {
                        Message: 'hello',
                        TopicArn: 'topicarn'
                    },
                    physicalResourceId: 'topicarn'
                }
            }
        };
        const request = createRequest(body => body.Status === 'SUCCESS' &&
            body.PhysicalResourceId === 'topicarn');
        await aws_custom_resource_provider_1.handler(event, {});
        test.equal(request.isDone(), true);
        test.done();
    },
    async 'delete event'(test) {
        const listObjectsFake = sinon.fake.resolves({});
        AWS.mock('S3', 'listObjects', listObjectsFake);
        const event = {
            ...eventCommon,
            RequestType: 'Delete',
            PhysicalResourceId: 'physicalResourceId',
            ResourceProperties: {
                ServiceToken: 'token',
                Create: {
                    service: 'S3',
                    action: 'listObjects',
                    parameters: {
                        Bucket: 'my-bucket'
                    },
                    physicalResourceIdPath: 'Contents.1.ETag'
                }
            }
        };
        const request = createRequest(body => body.Status === 'SUCCESS' &&
            body.PhysicalResourceId === 'physicalResourceId' &&
            Object.keys(body.Data).length === 0);
        await aws_custom_resource_provider_1.handler(event, {});
        sinon.assert.notCalled(listObjectsFake);
        test.equal(request.isDone(), true);
        test.done();
    },
    async 'catch errors'(test) {
        const error = new Error();
        error.code = 'NoSuchBucket';
        const listObjectsFake = sinon.fake.rejects(error);
        AWS.mock('S3', 'listObjects', listObjectsFake);
        const event = {
            ...eventCommon,
            RequestType: 'Create',
            ResourceProperties: {
                ServiceToken: 'token',
                Create: {
                    service: 'S3',
                    action: 'listObjects',
                    parameters: {
                        Bucket: 'my-bucket'
                    },
                    physicalResourceId: 'physicalResourceId',
                    catchErrorPattern: 'NoSuchBucket'
                }
            }
        };
        const request = createRequest(body => body.Status === 'SUCCESS' &&
            body.PhysicalResourceId === 'physicalResourceId' &&
            Object.keys(body.Data).length === 0);
        await aws_custom_resource_provider_1.handler(event, {});
        test.equal(request.isDone(), true);
        test.done();
    },
    async 'fixes booleans'(test) {
        const getParameterFake = sinon.fake.resolves({});
        AWS.mock('SSM', 'getParameter', getParameterFake);
        const event = {
            ...eventCommon,
            RequestType: 'Create',
            ResourceProperties: {
                ServiceToken: 'token',
                Create: {
                    service: 'SSM',
                    action: 'getParameter',
                    parameters: {
                        Name: 'my-parameter',
                        WithDecryption: 'true'
                    },
                    physicalResourceId: 'my-parameter'
                }
            }
        };
        const request = createRequest(body => body.Status === 'SUCCESS');
        await aws_custom_resource_provider_1.handler(event, {});
        sinon.assert.calledWith(getParameterFake, {
            Name: 'my-parameter',
            WithDecryption: true // boolean
        });
        test.equal(request.isDone(), true);
        test.done();
    },
    async 'restrict output path'(test) {
        const listObjectsFake = sinon.fake.resolves({
            Contents: [
                {
                    Key: 'first-key',
                    ETag: 'first-key-etag'
                },
                {
                    Key: 'second-key',
                    ETag: 'second-key-etag',
                }
            ]
        });
        AWS.mock('S3', 'listObjects', listObjectsFake);
        const event = {
            ...eventCommon,
            RequestType: 'Create',
            ResourceProperties: {
                ServiceToken: 'token',
                Create: {
                    service: 'S3',
                    action: 'listObjects',
                    parameters: {
                        Bucket: 'my-bucket'
                    },
                    physicalResourceId: 'id',
                    outputPath: 'Contents.0'
                }
            }
        };
        const request = createRequest(body => body.Status === 'SUCCESS' &&
            body.PhysicalResourceId === 'id' &&
            body.Data['Contents.0.Key'] === 'first-key' &&
            body.Data['Contents.1.Key'] === undefined);
        await aws_custom_resource_provider_1.handler(event, {});
        test.equal(request.isDone(), true);
        test.done();
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVzdC5hd3MtY3VzdG9tLXJlc291cmNlLXByb3ZpZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidGVzdC5hd3MtY3VzdG9tLXJlc291cmNlLXByb3ZpZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFDQSxvQ0FBcUM7QUFDckMsNkJBQThCO0FBRTlCLCtCQUFnQztBQUVoQyxzRkFBOEQ7QUFFOUQsTUFBTSxXQUFXLEdBQUc7SUFDbEIsWUFBWSxFQUFFLE9BQU87SUFDckIsV0FBVyxFQUFFLG1CQUFtQjtJQUNoQyxPQUFPLEVBQUUsU0FBUztJQUNsQixTQUFTLEVBQUUsV0FBVztJQUN0QixpQkFBaUIsRUFBRSxtQkFBbUI7SUFDdEMsWUFBWSxFQUFFLGFBQWE7Q0FDNUIsQ0FBQztBQUVGLFNBQVMsYUFBYSxDQUFDLGFBQWdGO0lBQ3JHLE9BQU8sSUFBSSxDQUFDLG1CQUFtQixDQUFDO1NBQzdCLEdBQUcsQ0FBQyxHQUFHLEVBQUUsYUFBYSxDQUFDO1NBQ3ZCLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUNoQixDQUFDO0FBRUQsaUJBQVM7SUFDUCxVQUFVLENBQUMsUUFBYTtRQUN0QixHQUFHLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDZCxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDaEIsUUFBUSxFQUFFLENBQUM7SUFDYixDQUFDO0lBRUQsS0FBSyxDQUFDLDZDQUE2QyxDQUFDLElBQVU7UUFDNUQsTUFBTSxlQUFlLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUM7WUFDMUMsUUFBUSxFQUFFO2dCQUNSO29CQUNFLEdBQUcsRUFBRSxXQUFXO29CQUNoQixJQUFJLEVBQUUsZ0JBQWdCO2lCQUN2QjtnQkFDRDtvQkFDRSxHQUFHLEVBQUUsWUFBWTtvQkFDakIsSUFBSSxFQUFFLGlCQUFpQjtpQkFDeEI7YUFDRjtTQUMwQixDQUFDLENBQUM7UUFFL0IsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsYUFBYSxFQUFFLGVBQWUsQ0FBQyxDQUFDO1FBRS9DLE1BQU0sS0FBSyxHQUFzRDtZQUMvRCxHQUFHLFdBQVc7WUFDZCxXQUFXLEVBQUUsUUFBUTtZQUNyQixrQkFBa0IsRUFBRTtnQkFDbEIsWUFBWSxFQUFFLE9BQU87Z0JBQ3JCLE1BQU0sRUFBRTtvQkFDTixPQUFPLEVBQUUsSUFBSTtvQkFDYixNQUFNLEVBQUUsYUFBYTtvQkFDckIsVUFBVSxFQUFFO3dCQUNWLE1BQU0sRUFBRSxXQUFXO3FCQUNwQjtvQkFDRCxzQkFBc0IsRUFBRSxpQkFBaUI7aUJBQzVCO2FBQ2hCO1NBQ0YsQ0FBQztRQUVGLE1BQU0sT0FBTyxHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUNuQyxJQUFJLENBQUMsTUFBTSxLQUFLLFNBQVM7WUFDekIsSUFBSSxDQUFDLGtCQUFrQixLQUFLLGlCQUFpQjtZQUM3QyxJQUFJLENBQUMsSUFBSyxDQUFDLGdCQUFnQixDQUFDLEtBQUssV0FBVyxDQUM3QyxDQUFDO1FBRUYsTUFBTSxzQ0FBTyxDQUFDLEtBQUssRUFBRSxFQUF1QixDQUFDLENBQUM7UUFFOUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsZUFBZSxFQUFFO1lBQ3ZDLE1BQU0sRUFBRSxXQUFXO1NBQ3BCLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRW5DLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNkLENBQUM7SUFFRCxLQUFLLENBQUMsd0NBQXdDLENBQUMsSUFBVTtRQUN2RCxNQUFNLE9BQU8sR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUV4QyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFFcEMsTUFBTSxLQUFLLEdBQXNEO1lBQy9ELEdBQUcsV0FBVztZQUNkLFdBQVcsRUFBRSxRQUFRO1lBQ3JCLGtCQUFrQixFQUFFLG9CQUFvQjtZQUN4QyxxQkFBcUIsRUFBRSxFQUFFO1lBQ3pCLGtCQUFrQixFQUFFO2dCQUNsQixZQUFZLEVBQUUsT0FBTztnQkFDckIsTUFBTSxFQUFFO29CQUNOLE9BQU8sRUFBRSxLQUFLO29CQUNkLE1BQU0sRUFBRSxTQUFTO29CQUNqQixVQUFVLEVBQUU7d0JBQ1YsT0FBTyxFQUFFLE9BQU87d0JBQ2hCLFFBQVEsRUFBRSxVQUFVO3FCQUNyQjtvQkFDRCxrQkFBa0IsRUFBRSxVQUFVO2lCQUNqQjthQUNoQjtTQUNGLENBQUM7UUFFRixNQUFNLE9BQU8sR0FBRyxhQUFhLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FDbkMsSUFBSSxDQUFDLE1BQU0sS0FBSyxTQUFTO1lBQ3pCLElBQUksQ0FBQyxrQkFBa0IsS0FBSyxVQUFVLENBQ3ZDLENBQUM7UUFFRixNQUFNLHNDQUFPLENBQUMsS0FBSyxFQUFFLEVBQXVCLENBQUMsQ0FBQztRQUU5QyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUVuQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDZCxDQUFDO0lBRUQsS0FBSyxDQUFDLGNBQWMsQ0FBQyxJQUFVO1FBQzdCLE1BQU0sZUFBZSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRWhELEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLGFBQWEsRUFBRSxlQUFlLENBQUMsQ0FBQztRQUUvQyxNQUFNLEtBQUssR0FBc0Q7WUFDL0QsR0FBRyxXQUFXO1lBQ2QsV0FBVyxFQUFFLFFBQVE7WUFDckIsa0JBQWtCLEVBQUUsb0JBQW9CO1lBQ3hDLGtCQUFrQixFQUFFO2dCQUNsQixZQUFZLEVBQUUsT0FBTztnQkFDckIsTUFBTSxFQUFFO29CQUNOLE9BQU8sRUFBRSxJQUFJO29CQUNiLE1BQU0sRUFBRSxhQUFhO29CQUNyQixVQUFVLEVBQUU7d0JBQ1YsTUFBTSxFQUFFLFdBQVc7cUJBQ3BCO29CQUNELHNCQUFzQixFQUFFLGlCQUFpQjtpQkFDNUI7YUFDaEI7U0FDRixDQUFDO1FBRUYsTUFBTSxPQUFPLEdBQUcsYUFBYSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQ25DLElBQUksQ0FBQyxNQUFNLEtBQUssU0FBUztZQUN6QixJQUFJLENBQUMsa0JBQWtCLEtBQUssb0JBQW9CO1lBQ2hELE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUssQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQ3JDLENBQUM7UUFFRixNQUFNLHNDQUFPLENBQUMsS0FBSyxFQUFFLEVBQXVCLENBQUMsQ0FBQztRQUU5QyxLQUFLLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUV4QyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUVuQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDZCxDQUFDO0lBRUQsS0FBSyxDQUFDLGNBQWMsQ0FBQyxJQUFVO1FBQzdCLE1BQU0sS0FBSyxHQUEwQixJQUFJLEtBQUssRUFBRSxDQUFDO1FBQ2pELEtBQUssQ0FBQyxJQUFJLEdBQUcsY0FBYyxDQUFDO1FBQzVCLE1BQU0sZUFBZSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRWxELEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLGFBQWEsRUFBRSxlQUFlLENBQUMsQ0FBQztRQUUvQyxNQUFNLEtBQUssR0FBc0Q7WUFDL0QsR0FBRyxXQUFXO1lBQ2QsV0FBVyxFQUFFLFFBQVE7WUFDckIsa0JBQWtCLEVBQUU7Z0JBQ2xCLFlBQVksRUFBRSxPQUFPO2dCQUNyQixNQUFNLEVBQUU7b0JBQ04sT0FBTyxFQUFFLElBQUk7b0JBQ2IsTUFBTSxFQUFFLGFBQWE7b0JBQ3JCLFVBQVUsRUFBRTt3QkFDVixNQUFNLEVBQUUsV0FBVztxQkFDcEI7b0JBQ0Qsa0JBQWtCLEVBQUUsb0JBQW9CO29CQUN4QyxpQkFBaUIsRUFBRSxjQUFjO2lCQUNwQjthQUNoQjtTQUNGLENBQUM7UUFFRixNQUFNLE9BQU8sR0FBRyxhQUFhLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FDbkMsSUFBSSxDQUFDLE1BQU0sS0FBSyxTQUFTO1lBQ3pCLElBQUksQ0FBQyxrQkFBa0IsS0FBSyxvQkFBb0I7WUFDaEQsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSyxDQUFDLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FDckMsQ0FBQztRQUVGLE1BQU0sc0NBQU8sQ0FBQyxLQUFLLEVBQUUsRUFBdUIsQ0FBQyxDQUFDO1FBRTlDLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRW5DLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNkLENBQUM7SUFFRCxLQUFLLENBQUMsZ0JBQWdCLENBQUMsSUFBVTtRQUMvQixNQUFNLGdCQUFnQixHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRWpELEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLGNBQWMsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO1FBRWxELE1BQU0sS0FBSyxHQUFzRDtZQUMvRCxHQUFHLFdBQVc7WUFDZCxXQUFXLEVBQUUsUUFBUTtZQUNyQixrQkFBa0IsRUFBRTtnQkFDbEIsWUFBWSxFQUFFLE9BQU87Z0JBQ3JCLE1BQU0sRUFBRTtvQkFDTixPQUFPLEVBQUUsS0FBSztvQkFDZCxNQUFNLEVBQUUsY0FBYztvQkFDdEIsVUFBVSxFQUFFO3dCQUNWLElBQUksRUFBRSxjQUFjO3dCQUNwQixjQUFjLEVBQUUsTUFBTTtxQkFDdkI7b0JBQ0Qsa0JBQWtCLEVBQUUsY0FBYztpQkFDckI7YUFDaEI7U0FDRixDQUFDO1FBRUYsTUFBTSxPQUFPLEdBQUcsYUFBYSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQ25DLElBQUksQ0FBQyxNQUFNLEtBQUssU0FBUyxDQUMxQixDQUFDO1FBRUYsTUFBTSxzQ0FBTyxDQUFDLEtBQUssRUFBRSxFQUF1QixDQUFDLENBQUM7UUFFOUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsZ0JBQWdCLEVBQUU7WUFDeEMsSUFBSSxFQUFFLGNBQWM7WUFDcEIsY0FBYyxFQUFFLElBQUksQ0FBQyxVQUFVO1NBQ2hDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRW5DLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNkLENBQUM7SUFFRCxLQUFLLENBQUMsc0JBQXNCLENBQUMsSUFBVTtRQUNyQyxNQUFNLGVBQWUsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQztZQUMxQyxRQUFRLEVBQUU7Z0JBQ1I7b0JBQ0UsR0FBRyxFQUFFLFdBQVc7b0JBQ2hCLElBQUksRUFBRSxnQkFBZ0I7aUJBQ3ZCO2dCQUNEO29CQUNFLEdBQUcsRUFBRSxZQUFZO29CQUNqQixJQUFJLEVBQUUsaUJBQWlCO2lCQUN4QjthQUNGO1NBQzBCLENBQUMsQ0FBQztRQUUvQixHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxhQUFhLEVBQUUsZUFBZSxDQUFDLENBQUM7UUFFL0MsTUFBTSxLQUFLLEdBQXNEO1lBQy9ELEdBQUcsV0FBVztZQUNkLFdBQVcsRUFBRSxRQUFRO1lBQ3JCLGtCQUFrQixFQUFFO2dCQUNsQixZQUFZLEVBQUUsT0FBTztnQkFDckIsTUFBTSxFQUFFO29CQUNOLE9BQU8sRUFBRSxJQUFJO29CQUNiLE1BQU0sRUFBRSxhQUFhO29CQUNyQixVQUFVLEVBQUU7d0JBQ1YsTUFBTSxFQUFFLFdBQVc7cUJBQ3BCO29CQUNELGtCQUFrQixFQUFFLElBQUk7b0JBQ3hCLFVBQVUsRUFBRSxZQUFZO2lCQUNYO2FBQ2hCO1NBQ0YsQ0FBQztRQUVGLE1BQU0sT0FBTyxHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUNuQyxJQUFJLENBQUMsTUFBTSxLQUFLLFNBQVM7WUFDekIsSUFBSSxDQUFDLGtCQUFrQixLQUFLLElBQUk7WUFDaEMsSUFBSSxDQUFDLElBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLFdBQVc7WUFDNUMsSUFBSSxDQUFDLElBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLFNBQVMsQ0FDM0MsQ0FBQztRQUVGLE1BQU0sc0NBQU8sQ0FBQyxLQUFLLEVBQUUsRUFBdUIsQ0FBQyxDQUFDO1FBRTlDLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRW5DLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNkLENBQUM7Q0FDRixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFNESyA9IHJlcXVpcmUoJ2F3cy1zZGsnKTtcbmltcG9ydCBBV1MgPSByZXF1aXJlKCdhd3Mtc2RrLW1vY2snKTtcbmltcG9ydCBub2NrID0gcmVxdWlyZSgnbm9jaycpO1xuaW1wb3J0IHsgVGVzdCB9IGZyb20gJ25vZGV1bml0JztcbmltcG9ydCBzaW5vbiA9IHJlcXVpcmUoJ3Npbm9uJyk7XG5pbXBvcnQgeyBBd3NTZGtDYWxsIH0gZnJvbSAnLi4vbGliJztcbmltcG9ydCB7IGhhbmRsZXIgfSBmcm9tICcuLi9saWIvYXdzLWN1c3RvbS1yZXNvdXJjZS1wcm92aWRlcic7XG5cbmNvbnN0IGV2ZW50Q29tbW9uID0ge1xuICBTZXJ2aWNlVG9rZW46ICd0b2tlbicsXG4gIFJlc3BvbnNlVVJMOiAnaHR0cHM6Ly9sb2NhbGhvc3QnLFxuICBTdGFja0lkOiAnc3RhY2tJZCcsXG4gIFJlcXVlc3RJZDogJ3JlcXVlc3RJZCcsXG4gIExvZ2ljYWxSZXNvdXJjZUlkOiAnbG9naWNhbFJlc291cmNlSWQnLFxuICBSZXNvdXJjZVR5cGU6ICdDdXN0b206OkFXUycsXG59O1xuXG5mdW5jdGlvbiBjcmVhdGVSZXF1ZXN0KGJvZHlQcmVkaWNhdGU6IChib2R5OiBBV1NMYW1iZGEuQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZVJlc3BvbnNlKSA9PiBib29sZWFuKSB7XG4gIHJldHVybiBub2NrKCdodHRwczovL2xvY2FsaG9zdCcpXG4gICAgLnB1dCgnLycsIGJvZHlQcmVkaWNhdGUpXG4gICAgLnJlcGx5KDIwMCk7XG59XG5cbmV4cG9ydCA9IHtcbiAgJ3RlYXJEb3duJyhjYWxsYmFjazogYW55KSB7XG4gICAgQVdTLnJlc3RvcmUoKTtcbiAgICBub2NrLmNsZWFuQWxsKCk7XG4gICAgY2FsbGJhY2soKTtcbiAgfSxcblxuICBhc3luYyAnY3JlYXRlIGV2ZW50IHdpdGggcGh5c2ljYWwgcmVzb3VyY2UgaWQgcGF0aCcodGVzdDogVGVzdCkge1xuICAgIGNvbnN0IGxpc3RPYmplY3RzRmFrZSA9IHNpbm9uLmZha2UucmVzb2x2ZXMoe1xuICAgICAgQ29udGVudHM6IFtcbiAgICAgICAge1xuICAgICAgICAgIEtleTogJ2ZpcnN0LWtleScsXG4gICAgICAgICAgRVRhZzogJ2ZpcnN0LWtleS1ldGFnJ1xuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgS2V5OiAnc2Vjb25kLWtleScsXG4gICAgICAgICAgRVRhZzogJ3NlY29uZC1rZXktZXRhZycsXG4gICAgICAgIH1cbiAgICAgIF1cbiAgICB9IGFzIFNESy5TMy5MaXN0T2JqZWN0c091dHB1dCk7XG5cbiAgICBBV1MubW9jaygnUzMnLCAnbGlzdE9iamVjdHMnLCBsaXN0T2JqZWN0c0Zha2UpO1xuXG4gICAgY29uc3QgZXZlbnQ6IEFXU0xhbWJkYS5DbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlQ3JlYXRlRXZlbnQgPSB7XG4gICAgICAuLi5ldmVudENvbW1vbixcbiAgICAgIFJlcXVlc3RUeXBlOiAnQ3JlYXRlJyxcbiAgICAgIFJlc291cmNlUHJvcGVydGllczoge1xuICAgICAgICBTZXJ2aWNlVG9rZW46ICd0b2tlbicsXG4gICAgICAgIENyZWF0ZToge1xuICAgICAgICAgIHNlcnZpY2U6ICdTMycsXG4gICAgICAgICAgYWN0aW9uOiAnbGlzdE9iamVjdHMnLFxuICAgICAgICAgIHBhcmFtZXRlcnM6IHtcbiAgICAgICAgICAgIEJ1Y2tldDogJ215LWJ1Y2tldCdcbiAgICAgICAgICB9LFxuICAgICAgICAgIHBoeXNpY2FsUmVzb3VyY2VJZFBhdGg6ICdDb250ZW50cy4xLkVUYWcnXG4gICAgICAgIH0gYXMgQXdzU2RrQ2FsbFxuICAgICAgfVxuICAgIH07XG5cbiAgICBjb25zdCByZXF1ZXN0ID0gY3JlYXRlUmVxdWVzdChib2R5ID0+XG4gICAgICBib2R5LlN0YXR1cyA9PT0gJ1NVQ0NFU1MnICYmXG4gICAgICBib2R5LlBoeXNpY2FsUmVzb3VyY2VJZCA9PT0gJ3NlY29uZC1rZXktZXRhZycgJiZcbiAgICAgIGJvZHkuRGF0YSFbJ0NvbnRlbnRzLjAuS2V5J10gPT09ICdmaXJzdC1rZXknXG4gICAgKTtcblxuICAgIGF3YWl0IGhhbmRsZXIoZXZlbnQsIHt9IGFzIEFXU0xhbWJkYS5Db250ZXh0KTtcblxuICAgIHNpbm9uLmFzc2VydC5jYWxsZWRXaXRoKGxpc3RPYmplY3RzRmFrZSwge1xuICAgICAgQnVja2V0OiAnbXktYnVja2V0J1xuICAgIH0pO1xuXG4gICAgdGVzdC5lcXVhbChyZXF1ZXN0LmlzRG9uZSgpLCB0cnVlKTtcblxuICAgIHRlc3QuZG9uZSgpO1xuICB9LFxuXG4gIGFzeW5jICd1cGRhdGUgZXZlbnQgd2l0aCBwaHlzaWNhbCByZXNvdXJjZSBpZCcodGVzdDogVGVzdCkge1xuICAgIGNvbnN0IHB1Ymxpc2ggPSBzaW5vbi5mYWtlLnJlc29sdmVzKHt9KTtcblxuICAgIEFXUy5tb2NrKCdTTlMnLCAncHVibGlzaCcsIHB1Ymxpc2gpO1xuXG4gICAgY29uc3QgZXZlbnQ6IEFXU0xhbWJkYS5DbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlVXBkYXRlRXZlbnQgPSB7XG4gICAgICAuLi5ldmVudENvbW1vbixcbiAgICAgIFJlcXVlc3RUeXBlOiAnVXBkYXRlJyxcbiAgICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogJ3BoeXNpY2FsUmVzb3VyY2VJZCcsXG4gICAgICBPbGRSZXNvdXJjZVByb3BlcnRpZXM6IHt9LFxuICAgICAgUmVzb3VyY2VQcm9wZXJ0aWVzOiB7XG4gICAgICAgIFNlcnZpY2VUb2tlbjogJ3Rva2VuJyxcbiAgICAgICAgVXBkYXRlOiB7XG4gICAgICAgICAgc2VydmljZTogJ1NOUycsXG4gICAgICAgICAgYWN0aW9uOiAncHVibGlzaCcsXG4gICAgICAgICAgcGFyYW1ldGVyczoge1xuICAgICAgICAgICAgTWVzc2FnZTogJ2hlbGxvJyxcbiAgICAgICAgICAgIFRvcGljQXJuOiAndG9waWNhcm4nXG4gICAgICAgICAgfSxcbiAgICAgICAgICBwaHlzaWNhbFJlc291cmNlSWQ6ICd0b3BpY2FybidcbiAgICAgICAgfSBhcyBBd3NTZGtDYWxsXG4gICAgICB9XG4gICAgfTtcblxuICAgIGNvbnN0IHJlcXVlc3QgPSBjcmVhdGVSZXF1ZXN0KGJvZHkgPT5cbiAgICAgIGJvZHkuU3RhdHVzID09PSAnU1VDQ0VTUycgJiZcbiAgICAgIGJvZHkuUGh5c2ljYWxSZXNvdXJjZUlkID09PSAndG9waWNhcm4nXG4gICAgKTtcblxuICAgIGF3YWl0IGhhbmRsZXIoZXZlbnQsIHt9IGFzIEFXU0xhbWJkYS5Db250ZXh0KTtcblxuICAgIHRlc3QuZXF1YWwocmVxdWVzdC5pc0RvbmUoKSwgdHJ1ZSk7XG5cbiAgICB0ZXN0LmRvbmUoKTtcbiAgfSxcblxuICBhc3luYyAnZGVsZXRlIGV2ZW50Jyh0ZXN0OiBUZXN0KSB7XG4gICAgY29uc3QgbGlzdE9iamVjdHNGYWtlID0gc2lub24uZmFrZS5yZXNvbHZlcyh7fSk7XG5cbiAgICBBV1MubW9jaygnUzMnLCAnbGlzdE9iamVjdHMnLCBsaXN0T2JqZWN0c0Zha2UpO1xuXG4gICAgY29uc3QgZXZlbnQ6IEFXU0xhbWJkYS5DbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlRGVsZXRlRXZlbnQgPSB7XG4gICAgICAuLi5ldmVudENvbW1vbixcbiAgICAgIFJlcXVlc3RUeXBlOiAnRGVsZXRlJyxcbiAgICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogJ3BoeXNpY2FsUmVzb3VyY2VJZCcsXG4gICAgICBSZXNvdXJjZVByb3BlcnRpZXM6IHtcbiAgICAgICAgU2VydmljZVRva2VuOiAndG9rZW4nLFxuICAgICAgICBDcmVhdGU6IHtcbiAgICAgICAgICBzZXJ2aWNlOiAnUzMnLFxuICAgICAgICAgIGFjdGlvbjogJ2xpc3RPYmplY3RzJyxcbiAgICAgICAgICBwYXJhbWV0ZXJzOiB7XG4gICAgICAgICAgICBCdWNrZXQ6ICdteS1idWNrZXQnXG4gICAgICAgICAgfSxcbiAgICAgICAgICBwaHlzaWNhbFJlc291cmNlSWRQYXRoOiAnQ29udGVudHMuMS5FVGFnJ1xuICAgICAgICB9IGFzIEF3c1Nka0NhbGxcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgY29uc3QgcmVxdWVzdCA9IGNyZWF0ZVJlcXVlc3QoYm9keSA9PlxuICAgICAgYm9keS5TdGF0dXMgPT09ICdTVUNDRVNTJyAmJlxuICAgICAgYm9keS5QaHlzaWNhbFJlc291cmNlSWQgPT09ICdwaHlzaWNhbFJlc291cmNlSWQnICYmXG4gICAgICBPYmplY3Qua2V5cyhib2R5LkRhdGEhKS5sZW5ndGggPT09IDBcbiAgICApO1xuXG4gICAgYXdhaXQgaGFuZGxlcihldmVudCwge30gYXMgQVdTTGFtYmRhLkNvbnRleHQpO1xuXG4gICAgc2lub24uYXNzZXJ0Lm5vdENhbGxlZChsaXN0T2JqZWN0c0Zha2UpO1xuXG4gICAgdGVzdC5lcXVhbChyZXF1ZXN0LmlzRG9uZSgpLCB0cnVlKTtcblxuICAgIHRlc3QuZG9uZSgpO1xuICB9LFxuXG4gIGFzeW5jICdjYXRjaCBlcnJvcnMnKHRlc3Q6IFRlc3QpIHtcbiAgICBjb25zdCBlcnJvcjogTm9kZUpTLkVycm5vRXhjZXB0aW9uID0gbmV3IEVycm9yKCk7XG4gICAgZXJyb3IuY29kZSA9ICdOb1N1Y2hCdWNrZXQnO1xuICAgIGNvbnN0IGxpc3RPYmplY3RzRmFrZSA9IHNpbm9uLmZha2UucmVqZWN0cyhlcnJvcik7XG5cbiAgICBBV1MubW9jaygnUzMnLCAnbGlzdE9iamVjdHMnLCBsaXN0T2JqZWN0c0Zha2UpO1xuXG4gICAgY29uc3QgZXZlbnQ6IEFXU0xhbWJkYS5DbG91ZEZvcm1hdGlvbkN1c3RvbVJlc291cmNlQ3JlYXRlRXZlbnQgPSB7XG4gICAgICAuLi5ldmVudENvbW1vbixcbiAgICAgIFJlcXVlc3RUeXBlOiAnQ3JlYXRlJyxcbiAgICAgIFJlc291cmNlUHJvcGVydGllczoge1xuICAgICAgICBTZXJ2aWNlVG9rZW46ICd0b2tlbicsXG4gICAgICAgIENyZWF0ZToge1xuICAgICAgICAgIHNlcnZpY2U6ICdTMycsXG4gICAgICAgICAgYWN0aW9uOiAnbGlzdE9iamVjdHMnLFxuICAgICAgICAgIHBhcmFtZXRlcnM6IHtcbiAgICAgICAgICAgIEJ1Y2tldDogJ215LWJ1Y2tldCdcbiAgICAgICAgICB9LFxuICAgICAgICAgIHBoeXNpY2FsUmVzb3VyY2VJZDogJ3BoeXNpY2FsUmVzb3VyY2VJZCcsXG4gICAgICAgICAgY2F0Y2hFcnJvclBhdHRlcm46ICdOb1N1Y2hCdWNrZXQnXG4gICAgICAgIH0gYXMgQXdzU2RrQ2FsbFxuICAgICAgfVxuICAgIH07XG5cbiAgICBjb25zdCByZXF1ZXN0ID0gY3JlYXRlUmVxdWVzdChib2R5ID0+XG4gICAgICBib2R5LlN0YXR1cyA9PT0gJ1NVQ0NFU1MnICYmXG4gICAgICBib2R5LlBoeXNpY2FsUmVzb3VyY2VJZCA9PT0gJ3BoeXNpY2FsUmVzb3VyY2VJZCcgJiZcbiAgICAgIE9iamVjdC5rZXlzKGJvZHkuRGF0YSEpLmxlbmd0aCA9PT0gMFxuICAgICk7XG5cbiAgICBhd2FpdCBoYW5kbGVyKGV2ZW50LCB7fSBhcyBBV1NMYW1iZGEuQ29udGV4dCk7XG5cbiAgICB0ZXN0LmVxdWFsKHJlcXVlc3QuaXNEb25lKCksIHRydWUpO1xuXG4gICAgdGVzdC5kb25lKCk7XG4gIH0sXG5cbiAgYXN5bmMgJ2ZpeGVzIGJvb2xlYW5zJyh0ZXN0OiBUZXN0KSB7XG4gICAgY29uc3QgZ2V0UGFyYW1ldGVyRmFrZSA9IHNpbm9uLmZha2UucmVzb2x2ZXMoe30pO1xuXG4gICAgQVdTLm1vY2soJ1NTTScsICdnZXRQYXJhbWV0ZXInLCBnZXRQYXJhbWV0ZXJGYWtlKTtcblxuICAgIGNvbnN0IGV2ZW50OiBBV1NMYW1iZGEuQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZUNyZWF0ZUV2ZW50ID0ge1xuICAgICAgLi4uZXZlbnRDb21tb24sXG4gICAgICBSZXF1ZXN0VHlwZTogJ0NyZWF0ZScsXG4gICAgICBSZXNvdXJjZVByb3BlcnRpZXM6IHtcbiAgICAgICAgU2VydmljZVRva2VuOiAndG9rZW4nLFxuICAgICAgICBDcmVhdGU6IHtcbiAgICAgICAgICBzZXJ2aWNlOiAnU1NNJyxcbiAgICAgICAgICBhY3Rpb246ICdnZXRQYXJhbWV0ZXInLFxuICAgICAgICAgIHBhcmFtZXRlcnM6IHtcbiAgICAgICAgICAgIE5hbWU6ICdteS1wYXJhbWV0ZXInLFxuICAgICAgICAgICAgV2l0aERlY3J5cHRpb246ICd0cnVlJ1xuICAgICAgICAgIH0sXG4gICAgICAgICAgcGh5c2ljYWxSZXNvdXJjZUlkOiAnbXktcGFyYW1ldGVyJ1xuICAgICAgICB9IGFzIEF3c1Nka0NhbGxcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgY29uc3QgcmVxdWVzdCA9IGNyZWF0ZVJlcXVlc3QoYm9keSA9PlxuICAgICAgYm9keS5TdGF0dXMgPT09ICdTVUNDRVNTJ1xuICAgICk7XG5cbiAgICBhd2FpdCBoYW5kbGVyKGV2ZW50LCB7fSBhcyBBV1NMYW1iZGEuQ29udGV4dCk7XG5cbiAgICBzaW5vbi5hc3NlcnQuY2FsbGVkV2l0aChnZXRQYXJhbWV0ZXJGYWtlLCB7XG4gICAgICBOYW1lOiAnbXktcGFyYW1ldGVyJyxcbiAgICAgIFdpdGhEZWNyeXB0aW9uOiB0cnVlIC8vIGJvb2xlYW5cbiAgICB9KTtcblxuICAgIHRlc3QuZXF1YWwocmVxdWVzdC5pc0RvbmUoKSwgdHJ1ZSk7XG5cbiAgICB0ZXN0LmRvbmUoKTtcbiAgfSxcblxuICBhc3luYyAncmVzdHJpY3Qgb3V0cHV0IHBhdGgnKHRlc3Q6IFRlc3QpIHtcbiAgICBjb25zdCBsaXN0T2JqZWN0c0Zha2UgPSBzaW5vbi5mYWtlLnJlc29sdmVzKHtcbiAgICAgIENvbnRlbnRzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBLZXk6ICdmaXJzdC1rZXknLFxuICAgICAgICAgIEVUYWc6ICdmaXJzdC1rZXktZXRhZydcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIEtleTogJ3NlY29uZC1rZXknLFxuICAgICAgICAgIEVUYWc6ICdzZWNvbmQta2V5LWV0YWcnLFxuICAgICAgICB9XG4gICAgICBdXG4gICAgfSBhcyBTREsuUzMuTGlzdE9iamVjdHNPdXRwdXQpO1xuXG4gICAgQVdTLm1vY2soJ1MzJywgJ2xpc3RPYmplY3RzJywgbGlzdE9iamVjdHNGYWtlKTtcblxuICAgIGNvbnN0IGV2ZW50OiBBV1NMYW1iZGEuQ2xvdWRGb3JtYXRpb25DdXN0b21SZXNvdXJjZUNyZWF0ZUV2ZW50ID0ge1xuICAgICAgLi4uZXZlbnRDb21tb24sXG4gICAgICBSZXF1ZXN0VHlwZTogJ0NyZWF0ZScsXG4gICAgICBSZXNvdXJjZVByb3BlcnRpZXM6IHtcbiAgICAgICAgU2VydmljZVRva2VuOiAndG9rZW4nLFxuICAgICAgICBDcmVhdGU6IHtcbiAgICAgICAgICBzZXJ2aWNlOiAnUzMnLFxuICAgICAgICAgIGFjdGlvbjogJ2xpc3RPYmplY3RzJyxcbiAgICAgICAgICBwYXJhbWV0ZXJzOiB7XG4gICAgICAgICAgICBCdWNrZXQ6ICdteS1idWNrZXQnXG4gICAgICAgICAgfSxcbiAgICAgICAgICBwaHlzaWNhbFJlc291cmNlSWQ6ICdpZCcsXG4gICAgICAgICAgb3V0cHV0UGF0aDogJ0NvbnRlbnRzLjAnXG4gICAgICAgIH0gYXMgQXdzU2RrQ2FsbFxuICAgICAgfVxuICAgIH07XG5cbiAgICBjb25zdCByZXF1ZXN0ID0gY3JlYXRlUmVxdWVzdChib2R5ID0+XG4gICAgICBib2R5LlN0YXR1cyA9PT0gJ1NVQ0NFU1MnICYmXG4gICAgICBib2R5LlBoeXNpY2FsUmVzb3VyY2VJZCA9PT0gJ2lkJyAmJlxuICAgICAgYm9keS5EYXRhIVsnQ29udGVudHMuMC5LZXknXSA9PT0gJ2ZpcnN0LWtleScgJiZcbiAgICAgIGJvZHkuRGF0YSFbJ0NvbnRlbnRzLjEuS2V5J10gPT09IHVuZGVmaW5lZFxuICAgICk7XG5cbiAgICBhd2FpdCBoYW5kbGVyKGV2ZW50LCB7fSBhcyBBV1NMYW1iZGEuQ29udGV4dCk7XG5cbiAgICB0ZXN0LmVxdWFsKHJlcXVlc3QuaXNEb25lKCksIHRydWUpO1xuXG4gICAgdGVzdC5kb25lKCk7XG4gIH0sXG59O1xuIl19